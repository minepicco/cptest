version: 2
jobs:
  build:
    docker:
      - image: minepicco/cci-aws-docker:latest
        environment:
          image: "minepicco/cptest"
          tag1: $CIRCLE_BUILD_NUM
          tag2: $CIRCLE_BUILD_NUM"_2"
    steps:
      - checkout
      - setup_remote_docker

      - run:
          name: build
          command: |
            docker build -t $image":"$CIRCLE_BUILD_NUM .
            docker tag $image":"$tag1 $image":"$CIRCLE_BUILD_NUM"_2"
      - run:
          name: docker login
          command: docker login -u $username -p $password #-e $mailaddress     
      - run:
          name: docker push
          command: |
            docker push $image":"$CIRCLE_BUILD_NUM 
            docker push $image":"$CIRCLE_BUILD_NUM"_2"
      - run:
          name: kick regscan
          command: |
            curl -k -u $TL_PASS -X POST $TL_URL"/api/v1/registry/scan" -d '{"tag":{"registry":"","repo":"'$image'","tag":""}}'
            echo "Completed"
