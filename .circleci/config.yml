version: 2
jobs:
  build:
    docker:
      - image: minepicco/cci-aws-docker:latest
        environment:
          image: "minepicco/cptest"
          tag1: "1"
          tag2: "2"
    steps:
      - checkout
      - setup_remote_docker

      - run:
          name: build
          command: |
            docker build -t $image":"$tag1 .
            docker tag $image":"$tag1 $image":"$tagï¼’
      - run:
          name: docker login
          command: docker login -u $username -p $password #-e $mailaddress     
      - run:
          name: docker push
          command: |
            docker push $image":"$tag1 
            docker push $image":"$tag2
      - run:
          name: kick regscan
          command: |
            curl -k -u $TL_PASS -X POST $TL_URL"/api/v1/registry/scan" -d '{"tag":{"registry":"","repo":"'$image'","tag":"'$tag1'"}}'
            curl -k -u $TL_PASS -X POST $TL_URL"/api/v1/registry/scan" -d '{"tag":{"registry":"","repo":"'$image'","tag":"'$tag2'"}}'
